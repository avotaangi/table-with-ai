<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{% static 'images/ico.png' %}" type="image/png">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞</title>
</head>
<body>
<div class="container mt-5">
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞</h1>
    <div class="mb-4">
        <strong>–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:</strong>
            <textarea name="query_text" id="query_text" class="form-control" rows="4" readonly required>{{ query.query_text }}</textarea>
    </div>
    <form id="table-form" method="POST" action="{% url 'query_save' query.pk %}">
        {% csrf_token %}
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="add-row" type="button" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
        </div>
        <table class="table table-bordered">
            <thead>
            <tr>
                {% for header in query.table_data.0.keys %}
                <th>{{ header }}</th>
                {% endfor %}
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            {% for row in query.table_data %}
            <tr>
                {% for value in row.values %}
                <td contenteditable="true">{{ value }}</td>
                {% endfor %}
                <td>
                    <button type="button" class="btn btn-sm btn-danger delete-row">–£–¥–∞–ª–∏—Ç—å</button>
                    <button type="button" class="btn btn-sm btn-secondary move-up">‚Üë</button>
                    <button type="button" class="btn btn-sm btn-secondary move-down">‚Üì</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </form>
    <br>
    <a href="{% url 'query_download' query.pk 'xlsx' %}" class="btn btn-success">–°–∫–∞—á–∞—Ç—å XLSX</a>
    <a href="{% url 'query_download' query.pk 'csv' %}" class="btn btn-info">–°–∫–∞—á–∞—Ç—å CSV</a>

    <a href="{% url 'query_edit' query.pk %}" class="btn btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å</a>
    <a href="{% url 'query_list' %}" class="btn btn-secondary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a>
</div>

–î–ª—è –≤—ã–Ω–µ—Å–µ–Ω–∏—è JavaScript-–∫–æ–¥–∞ –∏–∑ HTML-—Ñ–∞–π–ª–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª JavaScript
–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä, table-functions.js, –≤ –ø–∞–ø–∫–µ static/js –≤–∞—à–µ–≥–æ Django-–ø—Ä–æ–µ–∫—Ç–∞. –ü–æ–º–µ—Å—Ç–∏—Ç–µ –≤ –Ω–µ–≥–æ –≤–µ—Å—å JavaScript-–∫–æ–¥.

javascript
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
// table-functions.js

document.addEventListener('DOMContentLoaded', () => {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
    document.getElementById('add-row').addEventListener('click', () => {
        const tableBody = document.querySelector('table tbody');
        const headers = document.querySelectorAll('table thead th');
        const newRow = document.createElement('tr');

        // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–∏—Å–∫–ª—é—á–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü –¥–µ–π—Å—Ç–≤–∏–π)
        for (let i = 0; i < headers.length - 1; i++) {
            const cell = document.createElement('td');
            cell.contentEditable = 'true';
            cell.textContent = ''; // –ü—É—Å—Ç–∞—è —è—á–µ–π–∫–∞
            newRow.appendChild(cell);
        }

        // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫—É –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
        const actionsCell = document.createElement('td');
        actionsCell.innerHTML = `
            <button type="button" class="btn btn-sm btn-danger delete-row">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <button type="button" class="btn btn-sm btn-secondary move-up">‚Üë</button>
            <button type="button" class="btn btn-sm btn-secondary move-down">‚Üì</button>`;
        newRow.appendChild(actionsCell);

        tableBody.appendChild(newRow);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–≤–µ—Ä—Ö –∏ –≤–Ω–∏–∑
    document.querySelector('table tbody').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-row')) {
            e.target.closest('tr').remove();
        } else if (e.target.classList.contains('move-up')) {
            const currentRow = e.target.closest('tr');
            const previousRow = currentRow.previousElementSibling;
            if (previousRow) {
                currentRow.parentNode.insertBefore(currentRow, previousRow);
            }
        } else if (e.target.classList.contains('move-down')) {
            const currentRow = e.target.closest('tr');
            const nextRow = currentRow.nextElementSibling;
            if (nextRow) {
                currentRow.parentNode.insertBefore(nextRow, currentRow);
            }
        }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ fetch
    document.getElementById('table-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const tableRows = document.querySelectorAll('table tbody tr');
        const tableData = [];

        // –°–±–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∏—Å–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü "–î–µ–π—Å—Ç–≤–∏—è")
        const headers = Array.from(document.querySelectorAll('table thead th'))
            .slice(0, -1)
            .map(th => th.textContent.trim());
        tableData.push(headers);

        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
        tableRows.forEach(row => {
            const rowData = Array.from(row.querySelectorAll('td'))
                .slice(0, -1) // –ò—Å–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü "–î–µ–π—Å—Ç–≤–∏—è"
                .map(td => td.textContent.trim());
            if (rowData.length === headers.length) {
                tableData.push(rowData);
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ fetch
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ table_data: tableData })
        }).then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
            });
    });
});
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ HTML-—Ñ–∞–π–ª–µ
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–≥ <script> –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ JavaScript-—Ñ–∞–π–ª–∞:

html
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
<script src="{% static 'js/table-functions.js' %}"></script>
–í –∏—Ç–æ–≥–µ, –≤–∞—à HTML-—Ñ–∞–π–ª –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:

html
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{% static 'images/ico.png' %}" type="image/png">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞</title>
</head>
<body>
<div class="container mt-5">
    <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞</h1>
    <div class="mb-4">
        <strong>–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:</strong>
            <textarea name="query_text" id="query_text" class="form-control" rows="4" readonly required>{{ query.query_text }}</textarea>
    </div>
    <form id="table-form" method="POST" action="{% url 'query_save' query.pk %}">
        {% csrf_token %}
        <div class="mb-3">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="add-row" type="button" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
        </div>
        <table class="table table-bordered">
            <thead>
            <tr>
                {% for header in query.table_data.0.keys %}
                <th>{{ header }}</th>
                {% endfor %}
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
            </thead>
            <tbody>
            {% for row in query.table_data %}
            <tr>
                {% for value in row.values %}
                <td contenteditable="true">{{ value }}</td>
                {% endfor %}
                <td>
                    <button type="button" class="btn btn-sm btn-danger delete-row">–£–¥–∞–ª–∏—Ç—å</button>
                    <button type="button" class="btn btn-sm btn-secondary move-up">‚Üë</button>
                    <button type="button" class="btn btn-sm btn-secondary move-down">‚Üì</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </form>
    <br>
    <a href="{% url 'query_download' query.pk 'xlsx' %}" class="btn btn-success">–°–∫–∞—á–∞—Ç—å XLSX</a>
    <a href="{% url 'query_download' query.pk 'csv' %}" class="btn btn-info">–°–∫–∞—á–∞—Ç—å CSV</a>

    <a href="{% url 'query_edit' query.pk %}" class="btn btn-warning">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å</a>
    <a href="{% url 'query_list' %}" class="btn btn-secondary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<script src="{% static 'js/table-functions.js' %}"></script>
</body>
</html>
